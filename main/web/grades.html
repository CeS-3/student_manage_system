<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 1em;
        }

        nav {
            background-color: #f0f0f0;
            padding: 1em;
            width: 200px;
            position: fixed;
            height: 100%;
            overflow: auto;
        }

        main {
            margin-left: 220px;
            padding: 1em;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        button {
            padding: 10px;
            margin: 5px;
            cursor: pointer;
        }

        /* 搜索栏样式 */
        #searchBar {
            margin-bottom: 20px;
        }

        #searchBar input[type="text"] {
            padding: 10px;
        }

        #searchBar button {
            padding: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1>成绩信息</h1>
    </header>
    <main>
        <!-- 成绩信息展示页 -->
        <section id="gradesSection">
            <!-- 搜索栏 -->
            <div id="searchBar">
                <input type="text" id="searchInput" placeholder="输入学号搜索">
                <button onclick="searchGrades()">搜索</button>
            </div>

            <table id="gradesTable">
                <thead>
                    <tr>
                        <th>学号</th>
                        <th>姓名</th>
                        <th>课程名</th>
                        <th>课程号</th>
                        <th>成绩</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 成绩信息将动态填充至此 -->
                </tbody>
            </table>
        </section>
            <div id="gradeModal" class="modal">
                <div class="modal-content">
                    <h3 id="gradeModalTitle">新增成绩</h3>
                    <form id="gradeForm">
                        <label for="studentID">学号:</label>
                        <input type="text" id="studentID" name="studentID" required>
    
                        <label for="courseName">课程名:</label>
                        <input type="text" id="courseName" name="courseName" required>
    
                        <label for="courseID">课程号:</label>
                        <input type="text" id="courseID" name="courseID" required>
    
                        <label for="grade">成绩:</label>
                        <input type="text" id="grade" name="grade" required>
    
                        <button type="button" onclick="submitGradeForm()">确认</button>
                    </form>
                </div>
            </div>
    
            <!-- 成绩统计量展示页 -->
            <section id="attributionSection">
                <h2>成绩统计量</h2>
                <table id="attributionTable">
                    <thead>
                        <tr>
                            <th>专业</th>
                            <th>平均分</th>
                            <th>最高分</th>
                            <th>最低分</th>
                            <th>优秀率</th>
                            <th>不及格人数</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 成绩统计量信息将动态填充至此 -->
                    </tbody>
                </table>
            </section>
    
            <!-- 成绩排名展示页 -->
            <section id="rankSection">
                <h2>成绩排名</h2>
                <table id="rankTable">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>专业</th>
                            <th>学号</th>
                            <th>姓名</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 成绩排名信息将动态填充至此 -->
                    </tbody>
                </table>
            </section>
    
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // 获取成绩信息并显示
                fetchGrades();

                function fetchGrades() {
                    fetch("/grades")
                        .then(response => response.json())
                        .then(grades => {
                            displayGrades(grades);
                        })
                        .catch(error => console.error('Error fetching grades:', error));
                }

                function displayGrades(grades) {
                    const tableBody = document.querySelector("#gradesTable tbody");
                    tableBody.innerHTML = "";

                    grades.forEach(grade => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${grade.Sno}</td>
                            <td>${grade.Sname.String || ""}</td>
                            <td>${grade.Cname.String || ""}</td>
                            <td>${grade.Cno || ""}</td>
                            <td>${grade.Ggrade.Int32 || ""}</td>
                            <td>
                                <button onclick="updateGrade('${grade.Sno}')">更新</button>
                            </td>
                        `;
                    });
                }

                window.updateGrade = function(studentID) {
                    // 此处添加更新成绩信息的逻辑
                    
                    console.log(`Update grade for student with ID: ${studentID}`);
                }

                // window.deleteGrade = function(studentID) {
                //     const confirmDelete = confirm("确定要删除该学生成绩吗？");
                //     if (confirmDelete) {
                //         fetch(`/grades/${studentID}`, { method: 'DELETE' })
                //             .then(response => response.json())
                //             .then(result => {
                //                 console.log(result.message);
                //                 fetchGrades(); // 刷新成绩信息
                //             })
                //             .catch(error => console.error('Error deleting grade:', error));
                //     }
                // }

                // 搜索功能的逻辑
                function searchGrades() {
                    const searchInput = document.querySelector("#searchInput").value;
                    fetch(`/grades/search/${searchInput}`)
                        .then(response => response.json())
                        .then(results => {
                            // 显示搜索结果
                            displayGrades(results);
                        })
                        .catch(error => console.error('Error searching grades:', error));
                }

            });
            // 新增和修改成绩弹窗的逻辑
            const gradeModal = document.getElementById("gradeModal");
            const gradeForm = document.getElementById("gradeForm");
            const gradeModalTitle = document.getElementById("gradeModalTitle");

            function submitGradeForm() {
                // 提交新增/修改成绩的表单逻辑
                fetch("/grade/")                
            }

            // 成绩统计量和排名信息的获取和显示逻辑
            fetchGradesAttribution();
            fetchRanks();

            function fetchGradesAttribution() {
                // 获取成绩统计量信息并显示
                fetch("/grades/attribution")
                    .then(response => response.json())
                    .then(attributions => {
                        displayGradesAttribution(attributions);
                    })
                    .catch(error => console.error('Error fetching grades attribution:', error));
            }

            function displayGradesAttribution(attributions) {
                const tableBody = document.querySelector("#attributionTable tbody");
                tableBody.innerHTML = "";

                attributions.forEach(attribution => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${attribution.Sdept || "无"}</td>
                        <td>${attribution.Avg.Float64 || "无"}</td>
                        <td>${attribution.Max.Int32 || "无"}</td>
                        <td>${attribution.Min.Int32 || "无"}</td>
                        <td>${attribution.Erate.Float64 || "无"}</td>
                        <td>${attribution.Failers.Int32 || "0"}</td>
                    `;
                });
            }

            function fetchRanks() {
                // 获取成绩排名信息并显示
                fetch("/grades/rank")
                    .then(response => response.json())
                    .then(ranks => {
                        displayRanks(ranks);
                    })
                    .catch(error => console.error('Error fetching ranks:', error));
            }

            function displayRanks(ranks) {
                const tableBody = document.querySelector("#rankTable tbody");
                tableBody.innerHTML = "";

                ranks.forEach(rank => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${rank.Rrank.Int32 || ""}</td>
                        <td>${rank.Sdept.String || ""}</td>
                        <td>${rank.Sno || ""}</td>
                        <td>${rank.Sname.String || ""}</td>
                    `;
                });
            }
        </script>
    </main>
</body>
</html>